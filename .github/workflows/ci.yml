name: CI/CD Pipeline

on:
  push:
    branches: [main, staging, dev]
  pull_request:
    branches: [main, staging, dev]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip test execution'
        required: false
        type: boolean
        default: false

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  BUF_VERSION: "1.47.2"
  RUST_VERSION: "stable"
  PYTHON_VERSION: "3.12"
  GO_VERSION: "1.23"
  NODE_VERSION: "22"
  JAVA_VERSION: "21"
  PNPM_VERSION: "9"

permissions:
  contents: read
  pull-requests: write
  checks: write
  issues: write

jobs:
  # ============================================================================
  # Module Discovery
  # ============================================================================
  discover-modules:
    name: Discover Proto Modules
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      modules: ${{ steps.discover.outputs.modules }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Discover Proto Modules
        id: discover
        run: |
          # Discover all directories in proto/ (each directory is a module)
          modules=$(find proto -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(length > 0)) | sort')
          echo "Discovered modules: $modules"
          echo "modules=$modules" >> $GITHUB_OUTPUT

  # ============================================================================
  # Proto Validation & Code Generation
  # ============================================================================
  validate-proto:
    name: Validate Proto Files
    runs-on: ubuntu-latest
    needs: discover-modules
    timeout-minutes: 10
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for breaking change detection

      - name: Buf Lint, Format, and Breaking Change Detection
        uses: bufbuild/buf-action@v1
        with:
          version: ${{ env.BUF_VERSION }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          setup_only: false
          format: true
          lint: true
          breaking: ${{ github.event_name == 'pull_request' }}
          breaking_against: 'https://github.com/${{ github.repository }}.git#branch=${{ github.base_ref || github.event.repository.default_branch }},subdir=proto'
          comment: true
          pr_comment: ${{ github.event_name == 'pull_request' }}

      - name: Generate Proto Documentation
        run: |
          buf generate --template buf.gen.yaml --path proto || echo "Documentation generation skipped"

  # ============================================================================
  # Generate All Client Code
  # ============================================================================
  generate-clients:
    name: Generate Client Code
    runs-on: ubuntu-latest
    needs: validate-proto
    timeout-minutes: 15
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Buf
        uses: bufbuild/buf-action@v1
        with:
          version: ${{ env.BUF_VERSION }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          setup_only: true

      - name: Install Protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Generate All Clients
        run: buf generate

      - name: Upload Generated Clients
        uses: actions/upload-artifact@v4
        with:
          name: generated-clients
          path: clients/
          retention-days: 7

  # ============================================================================
  # Build & Test - Rust (Primary Language)
  # ============================================================================
  build-rust:
    name: Build & Test Rust
    runs-on: ubuntu-latest
    needs: [discover-modules, generate-clients]
    timeout-minutes: 30
    strategy:
      matrix:
        package: ${{ fromJson(needs.discover-modules.outputs.modules) }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Generated Clients
        uses: actions/download-artifact@v4
        with:
          name: generated-clients
          path: clients/

      - name: Setup Buf
        uses: bufbuild/buf-action@v1
        with:
          version: ${{ env.BUF_VERSION }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          setup_only: true

      - name: Setup Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt, clippy

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: clients/rust
          cache-on-failure: true

      - name: Install Protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Check Rust Format
        working-directory: clients/rust/${{ matrix.package }}
        run: cargo fmt -- --check

      - name: Cargo Check
        working-directory: clients/rust/${{ matrix.package }}
        run: cargo check --all-targets

      - name: Build Release
        working-directory: clients/rust/${{ matrix.package }}
        run: cargo build --release

      - name: Run Tests
        if: ${{ !inputs.skip_tests }}
        working-directory: clients/rust/${{ matrix.package }}
        run: cargo test --all-features

      - name: Run Clippy
        working-directory: clients/rust/${{ matrix.package }}
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Security Audit
        working-directory: clients/rust/${{ matrix.package }}
        run: |
          # Install cargo-audit (use 0.21.2 for compatibility with Rust 1.81+)
          if ! cargo install cargo-audit --version 0.21.2 2>/dev/null; then
            echo "Failed to install cargo-audit 0.21.2, trying latest..."
            cargo install cargo-audit || echo "cargo-audit installation failed"
          fi
          cargo audit || echo "Audit completed with warnings"

  # ============================================================================
  # Build & Test - Go
  # ============================================================================
  # build-go:
  #   name: Build & Test Go
  #   runs-on: ubuntu-latest
  #   needs: [discover-modules, generate-clients]
  #   timeout-minutes: 20
  #   strategy:
  #     matrix:
  #       module: ${{ fromJson(needs.discover-modules.outputs.modules) }}
  #   steps:
  #     - name: Checkout Code
  #       uses: actions/checkout@v4

  #     - name: Download Generated Clients
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: generated-clients
  #         path: clients/

  #     - name: Setup Go
  #       uses: actions/setup-go@v5
  #       with:
  #         go-version: ${{ env.GO_VERSION }}
  #         cache-dependency-path: clients/go/${{ matrix.module }}/go.sum

  #     - name: Go Mod Tidy
  #       working-directory: clients/go/${{ matrix.module }}
  #       run: go mod tidy

  #     - name: Go Vet
  #       working-directory: clients/go/${{ matrix.module }}
  #       run: go vet ./...

  #     - name: Build
  #       working-directory: clients/go/${{ matrix.module }}
  #       run: go build ./...

  #     - name: Run Tests
  #       if: ${{ !inputs.skip_tests }}
  #       working-directory: clients/go/${{ matrix.module }}
  #       run: go test -v -race -coverprofile=coverage.out ./...

  #     - name: Upload Coverage
  #       if: ${{ !inputs.skip_tests }}
  #       uses: codecov/codecov-action@v4
  #       with:
  #         files: clients/go/${{ matrix.module }}/coverage.out
  #         flags: go-${{ matrix.module }}
  #       continue-on-error: true

  # ============================================================================
  # Build & Test - Python
  # ============================================================================
  build-python:
    name: Build & Test Python
    runs-on: ubuntu-latest
    needs: [discover-modules, generate-clients]
    timeout-minutes: 20
    strategy:
      matrix:
        package: ${{ fromJson(needs.discover-modules.outputs.modules) }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Generated Clients
        uses: actions/download-artifact@v4
        with:
          name: generated-clients
          path: clients/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build pytest pytest-cov mypy ruff

      - name: Lint with Ruff
        working-directory: clients/python/${{ matrix.package }}
        run: ruff check . || echo "Ruff linting completed with warnings"

      - name: Type Check with MyPy
        working-directory: clients/python/${{ matrix.package }}
        run: mypy . || echo "Type checking completed with warnings"

      - name: Build Package
        working-directory: clients/python/${{ matrix.package }}
        run: python -m build

      - name: Run Tests
        if: ${{ !inputs.skip_tests }}
        working-directory: clients/python/${{ matrix.package }}
        run: pytest --cov --cov-report=xml || echo "No tests configured"

      - name: Upload Coverage
        if: ${{ !inputs.skip_tests }}
        uses: codecov/codecov-action@v4
        with:
          files: clients/python/${{ matrix.package }}/coverage.xml
          flags: python-${{ matrix.package }}
        continue-on-error: true

  # ============================================================================
  # Build & Test - TypeScript
  # ============================================================================
  build-typescript:
    name: Build & Test TypeScript
    runs-on: ubuntu-latest
    needs: [discover-modules, generate-clients]
    timeout-minutes: 20
    strategy:
      matrix:
        package: ${{ fromJson(needs.discover-modules.outputs.modules) }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Generated Clients
        uses: actions/download-artifact@v4
        with:
          name: generated-clients
          path: clients/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('clients/typescript/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Dependencies
        working-directory: clients/typescript
        run: pnpm install --frozen-lockfile || pnpm install

      - name: Lint
        working-directory: clients/typescript
        run: pnpm lint || echo "Linting completed with warnings"

      - name: Type Check
        working-directory: clients/typescript
        run: pnpm type-check || echo "Type checking completed with warnings"

      - name: Build
        working-directory: clients/typescript/packages/${{ matrix.package }}
        run: pnpm build || echo "Build completed with warnings"

      - name: Run Tests
        if: ${{ !inputs.skip_tests }}
        working-directory: clients/typescript
        run: pnpm test || echo "No tests configured"

  # ============================================================================
  # Build & Test - Java
  # ============================================================================
  # build-java:
  #   name: Build & Test Java
  #   runs-on: ubuntu-latest
  #   needs: [discover-modules, generate-clients]
  #   timeout-minutes: 20
  #   strategy:
  #     matrix:
  #       module: ${{ fromJson(needs.discover-modules.outputs.modules) }}
  #   steps:
  #     - name: Checkout Code
  #       uses: actions/checkout@v4

  #     - name: Download Generated Clients
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: generated-clients
  #         path: clients/

  #     - name: Setup Java
  #       uses: actions/setup-java@v4
  #       with:
  #         java-version: ${{ env.JAVA_VERSION }}
  #         distribution: 'temurin'
  #         cache: 'maven'

  #     - name: Build with Maven
  #       working-directory: clients/java
  #       run: mvn -B clean install -DskipTests=false -pl ${{ matrix.module }} -am

  #     - name: Run Tests
  #       if: ${{ !inputs.skip_tests }}
  #       working-directory: clients/java/${{ matrix.module }}
  #       run: mvn test

  # ============================================================================
  # Security Scanning
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate-proto
    timeout-minutes: 15
    permissions:
      security-events: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  # ============================================================================
  # Final Status Check
  # ============================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - validate-proto
      - generate-clients
      - build-rust
      # - build-go
      - build-python
      - build-typescript
      # - build-java
    if: always()
    steps:
      - name: Check All Jobs Status
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "❌ One or more jobs failed"
            exit 1
          elif [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "⚠️ One or more jobs were cancelled"
            exit 1
          else
            echo "✅ All jobs completed successfully"
          fi
