name: Release

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-alpha.*'
      - 'v*.*.*-beta.*'
      - 'v*.*.*-rc.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  discussions: write
  issues: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  BUF_VERSION: "1.47.2"

jobs:
  # ============================================================================
  # Validate Release
  # ============================================================================
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      tag_name: ${{ steps.version.outputs.tag_name }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG_NAME="v$VERSION"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG_NAME#v}"
            if [[ "$VERSION" =~ (alpha|beta|rc) ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

          echo "üì¶ Release Version: $VERSION"
          echo "üè∑Ô∏è  Tag Name: $TAG_NAME"
          echo "üîñ Pre-release: $IS_PRERELEASE"

      - name: Validate Version Format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-prerelease"
            exit 1
          fi
          echo "‚úÖ Version format is valid"

      - name: Check if Tag Exists
        if: github.event_name == 'workflow_dispatch'
        run: |
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ùå Tag $TAG_NAME already exists"
            exit 1
          fi
          echo "‚úÖ Tag $TAG_NAME is available"

      - name: Validate Proto Files with Buf
        uses: bufbuild/buf-action@v1
        with:
          version: ${{ env.BUF_VERSION }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          setup_only: false
          format: true
          lint: true
          comment: false

      - name: Validation Complete
        run: echo "‚úÖ Proto files are valid"

  # ============================================================================
  # Run CI Pipeline
  # ============================================================================
  ci:
    name: Run CI Pipeline
    needs: validate
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  # ============================================================================
  # Generate Changelog
  # ============================================================================
  changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: [validate, ci]
    timeout-minutes: 10
    outputs:
      changelog: ${{ steps.generate.outputs.changelog }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Changelog
        id: generate
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          TAG_NAME="${{ needs.validate.outputs.tag_name }}"

          echo "Generating changelog for $TAG_NAME"

          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 $TAG_NAME^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, listing recent commits"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -n 50)
          else
            echo "Comparing with $PREV_TAG"
            COMMITS=$(git log $PREV_TAG..$TAG_NAME --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -i "^- feat" || echo "")
          FIXES=$(echo "$COMMITS" | grep -i "^- fix" || echo "")
          BREAKING=$(echo "$COMMITS" | grep -i "BREAKING CHANGE" || echo "")
          DOCS=$(echo "$COMMITS" | grep -i "^- docs" || echo "")
          REFACTOR=$(echo "$COMMITS" | grep -i "^- refactor" || echo "")
          CHORE=$(echo "$COMMITS" | grep -i "^- chore" || echo "")
          OTHER=$(echo "$COMMITS" | grep -v -i "^- \(feat\|fix\|docs\|refactor\|chore\)" || echo "")

          # Create changelog
          cat > RELEASE_NOTES.md << 'NOTES'
          ## üéâ What's New in $TAG_NAME

          NOTES

          if [ -n "$BREAKING" ]; then
            echo "" >> RELEASE_NOTES.md
            echo "### ‚ö†Ô∏è Breaking Changes" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "$BREAKING" >> RELEASE_NOTES.md
          fi

          if [ -n "$FEATURES" ]; then
            echo "" >> RELEASE_NOTES.md
            echo "### ‚ú® New Features" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "$FEATURES" >> RELEASE_NOTES.md
          fi

          if [ -n "$FIXES" ]; then
            echo "" >> RELEASE_NOTES.md
            echo "### üêõ Bug Fixes" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "$FIXES" >> RELEASE_NOTES.md
          fi

          if [ -n "$DOCS" ]; then
            echo "" >> RELEASE_NOTES.md
            echo "### üìö Documentation" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "$DOCS" >> RELEASE_NOTES.md
          fi

          if [ -n "$REFACTOR" ]; then
            echo "" >> RELEASE_NOTES.md
            echo "### üî® Refactoring" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "$REFACTOR" >> RELEASE_NOTES.md
          fi

          if [ -n "$OTHER" ]; then
            echo "" >> RELEASE_NOTES.md
            echo "### üîß Other Changes" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "$OTHER" >> RELEASE_NOTES.md
          fi

          # Add installation instructions
          cat >> RELEASE_NOTES.md << 'INSTALL'

          ---

          ## üì¶ Installation

          ### Rust
          ```bash
          cargo add geniustechspace-core@$VERSION
          cargo add geniustechspace-idp@$VERSION
          cargo add geniustechspace-notification@$VERSION
          ```

          ### Python
          ```bash
          pip install geniustechspace-core==$VERSION
          pip install geniustechspace-idp==$VERSION
          pip install geniustechspace-notification==$VERSION
          ```

          ### TypeScript/JavaScript
          ```bash
          npm install @geniustechspace/core@$VERSION
          npm install @geniustechspace/idp@$VERSION
          npm install @geniustechspace/notification@$VERSION
          ```

          ### Go
          ```bash
          go get github.com/geniustechspace/api-contracts/clients/go/core@$TAG_NAME
          go get github.com/geniustechspace/api-contracts/clients/go/idp@$TAG_NAME
          go get github.com/geniustechspace/api-contracts/clients/go/notification@$TAG_NAME
          ```

          ### Java
          ```xml
          <dependency>
            <groupId>com.geniustechspace</groupId>
            <artifactId>api-contracts-core</artifactId>
            <version>$VERSION</version>
          </dependency>
          <dependency>
            <groupId>com.geniustechspace</groupId>
            <artifactId>api-contracts-idp</artifactId>
            <version>$VERSION</version>
          </dependency>
          <dependency>
            <groupId>com.geniustechspace</groupId>
            <artifactId>api-contracts-notification</artifactId>
            <version>$VERSION</version>
          </dependency>
          ```

          ---

          ## üîó Resources

          - üìñ [Documentation](https://github.com/geniustechspace/api-contracts#readme)
          - üèóÔ∏è [Architecture Guide](https://github.com/geniustechspace/api-contracts/blob/main/ARCHITECTURE.md)
          - üöÄ [Quick Start](https://github.com/geniustechspace/api-contracts/blob/main/QUICKSTART.md)
          - ü§ù [Contributing](https://github.com/geniustechspace/api-contracts/blob/main/CONTRIBUTING.md)
          - üêõ [Report Issues](https://github.com/geniustechspace/api-contracts/issues)
          - üí¨ [Discussions](https://github.com/geniustechspace/api-contracts/discussions)

          ---

          ## üôè Contributors

          Thank you to all contributors who made this release possible!

          **Full Changelog**: https://github.com/geniustechspace/api-contracts/compare/$PREV_TAG...$TAG_NAME
          INSTALL

          # Replace variables in the file
          sed -i "s|\$TAG_NAME|$TAG_NAME|g" RELEASE_NOTES.md
          sed -i "s|\$VERSION|$VERSION|g" RELEASE_NOTES.md
          sed -i "s|\$PREV_TAG|${PREV_TAG:-initial}|g" RELEASE_NOTES.md

          echo "Changelog generated:"
          cat RELEASE_NOTES.md

      - name: Upload Changelog
        uses: actions/upload-artifact@v4
        with:
          name: release-notes
          path: RELEASE_NOTES.md
          retention-days: 90

  # ============================================================================
  # Publish Packages
  # ============================================================================
  publish:
    name: Publish Packages
    needs: [validate, changelog]
    uses: ./.github/workflows/publish.yaml
    secrets: inherit
    with:
      version: ${{ needs.validate.outputs.version }}
      dry_run: false

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, changelog, publish]
    timeout-minutes: 10
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Changelog
        uses: actions/download-artifact@v4
        with:
          name: release-notes

      - name: Create or Update Tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ needs.validate.outputs.tag_name }} -m "Release ${{ needs.validate.outputs.version }}"
          git push origin ${{ needs.validate.outputs.tag_name }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate.outputs.tag_name }}
          name: Release ${{ needs.validate.outputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ needs.validate.outputs.is_prerelease }}
          generate_release_notes: false
          discussion_category_name: 'Announcements'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Post-Release Tasks
  # ============================================================================
  post-release:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [validate, create-release]
    timeout-minutes: 10
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Release Branch
        if: needs.validate.outputs.is_prerelease == 'false'
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          MAJOR_MINOR=$(echo $VERSION | cut -d. -f1-2)
          BRANCH_NAME="release/$MAJOR_MINOR"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git rev-parse --verify origin/$BRANCH_NAME >/dev/null 2>&1; then
            echo "Branch $BRANCH_NAME already exists"
            git checkout $BRANCH_NAME
            git merge ${{ needs.validate.outputs.tag_name }}
            git push origin $BRANCH_NAME
          else
            echo "Creating new branch $BRANCH_NAME"
            git checkout -b $BRANCH_NAME ${{ needs.validate.outputs.tag_name }}
            git push origin $BRANCH_NAME
          fi

      - name: Update CHANGELOG.md
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          DATE=$(date +%Y-%m-%d)

          if [ -f CHANGELOG.md ]; then
            # Prepend new version to existing changelog
            sed -i "1i\\## [$VERSION] - $DATE\n\nSee [Release Notes](https://github.com/geniustechspace/api-contracts/releases/tag/v$VERSION)\n" CHANGELOG.md
          else
            # Create new changelog
            cat > CHANGELOG.md << EOF
          # Changelog

          All notable changes to this project will be documented in this file.

          The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
          and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

          ## [$VERSION] - $DATE

          See [Release Notes](https://github.com/geniustechspace/api-contracts/releases/tag/v$VERSION)
          EOF
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "chore: update CHANGELOG for v$VERSION [skip ci]" || echo "No changes to commit"
          git push origin main || echo "Could not push to main"

      - name: Create Next Development Version
        if: needs.validate.outputs.is_prerelease == 'false'
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          NEXT_MINOR=$((MINOR + 1))
          NEXT_VERSION="$MAJOR.$NEXT_MINOR.0-dev"

          echo "Next development version: $NEXT_VERSION"

          # This would typically update version files
          # For now, just document it
          echo "# Development Version: $NEXT_VERSION" > .dev-version

  # ============================================================================
  # Notify Release
  # ============================================================================
  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [validate, create-release, post-release]
    if: always()
    timeout-minutes: 5
    steps:
      - name: Release Success Notification
        if: needs.create-release.result == 'success'
        run: |
          echo "‚úÖ Release ${{ needs.validate.outputs.version }} completed successfully!"
          echo "üì¶ Packages published to registries"
          echo "üéâ GitHub release created"
          echo "üîó https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate.outputs.tag_name }}"

      - name: Release Failure Notification
        if: needs.create-release.result != 'success'
        run: |
          echo "‚ùå Release ${{ needs.validate.outputs.version }} failed!"
          echo "Please check the logs for details"
          exit 1

  # ============================================================================
  # Cleanup
  # ============================================================================
  cleanup:
    name: Cleanup Artifacts
    runs-on: ubuntu-latest
    needs: [create-release]
    if: always()
    timeout-minutes: 5
    steps:
      - name: Delete Temporary Artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            generated-clients
            release-notes
        continue-on-error: true
