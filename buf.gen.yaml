version: v2

# =============================================================================
# Code Generation Configuration - Enterprise API Contracts
# =============================================================================
# This configuration generates CLIENT CODE ONLY for multiple languages.
# NO SERVER CODE is generated or should be implemented.
# 
# Supported Languages:
# 1. Rust       - Primary language, client-only with no_server option
# 2. Python     - Client stubs only (server stubs generated but unused)
# 3. TypeScript - Client code only (protobuf-ts generates clients by default)
#
# Generated Output Structure:
# - clients/rust/         → Rust crates (Tonic + Prost, client-only)
# - clients/python/       → Python packages (use client stubs only)
# - clients/typescript/   → TypeScript/JavaScript packages (client-only)
#
# Each proto module (proto/core, proto/idp, etc.) generates a standalone 
# package per language. Dependencies like google.protobuf and validate are
# NOT generated as packages - they come from official registries.
# =============================================================================

# =============================================================================
# Managed Mode Configuration
# =============================================================================
# Automatically manages package names and options across all generated code
# Note: We only generate code for proto modules we own (proto/core, proto/idp, etc.)
# Dependencies (google.protobuf, validate) are NOT generated - use official packages
managed:
  enabled: true
  disable:
    # Don't generate code for dependencies - use official packages from registries
    - module: buf.build/googleapis/googleapis
    - module: buf.build/envoyproxy/protoc-gen-validate
    - module: buf.build/grpc-ecosystem/grpc-gateway

# =============================================================================
# Input Configuration
# =============================================================================
inputs:
  - directory: proto

# =============================================================================
# Plugin Configuration
# =============================================================================
# Updated to latest stable versions (November 2025)
# Using remote plugins from buf.build for reliability and version control
# =============================================================================

plugins:
  # ===========================================================================
  # RUST - PRIMARY LANGUAGE
  # ===========================================================================
  # Each proto module becomes a separate Rust crate in the workspace
  # Example: proto/core/v1 → clients/rust/core/
  
  # Rust: Prost v0.4.0 - Message serialization/deserialization
  # Latest stable plugin version for Prost 0.13.x and Tonic 0.12.x
  - remote: buf.build/community/neoeinstein-prost:v0.4.0
    out: clients/rust
    opt:
      # Use bytes::Bytes for better performance
      - bytes=.
  
  # Rust: Tonic v0.4.0 - gRPC client code generation (client-only)
  # Latest stable plugin version for Tonic 0.12.x
  - remote: buf.build/community/neoeinstein-tonic:v0.4.0
    out: clients/rust
    opt:
      # Generate only client code, not server code
      - no_server
  
  # ===========================================================================
  # PYTHON - ML/DATA SERVICES & SCRIPTS
  # ===========================================================================
  # Each proto module becomes a separate Python package
  # Example: proto/core/v1 → clients/python/core/
  # Dependencies: Use official packages from PyPI (protobuf, grpcio)
  
  # Python: Protocol Buffer messages (protoc-gen-python v28.3 - November 2024)
  # Compatible with protobuf>=5.28.0
  - remote: buf.build/protocolbuffers/python:v28.3
    out: clients/python
  
  # Python: gRPC client stubs (grpcio v1.68.1 - November 2024)
  # Compatible with grpcio>=1.68.0
  # Note: Python plugin generates both client and server stubs - use client stubs only.
  - remote: buf.build/grpc/python:v1.68.1
    out: clients/python
  
  # ===========================================================================
  # TYPESCRIPT - WEB & NODE.JS
  # ===========================================================================
  # Each proto module becomes a separate npm package in the workspace
  # Example: proto/core/v1 → clients/typescript/packages/core/
  # Dependencies: Use official packages from npm (@grpc/grpc-js, protobufjs)
  
  # TypeScript: protobuf-ts v2.9.4 - Modern TypeScript support (October 2024)
  # Latest stable version with full TypeScript 5.x support
  - remote: buf.build/community/timostamm-protobuf-ts:v2.9.4
    out: clients/typescript/packages
    opt:
      # Use string for 64-bit integers (JavaScript compatibility)
      - long_type_string
