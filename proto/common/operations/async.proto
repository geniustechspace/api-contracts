syntax = "proto3";

package geniustechspace.common.operations.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/any.proto";
import "common/operations/types.proto";
import "common/operations/request.proto";
import "common/operations/response.proto";

// =============================================================================
// ASYNC OPERATION MESSAGES - v1.0.0
// =============================================================================
//
// This file defines messages for asynchronous operation execution, tracking,
// and lifecycle management across the organizations platform.
//
// DESIGN PRINCIPLES:
// - Support long-running operations
// - Enable operation polling and callbacks
// - Provide comprehensive status tracking
// - Support cancellation and retry
//
// VERSION HISTORY:
// - 1.0.0 (2025-11-01): Initial enterprise-standard release
//
// COMPLIANCE SCOPE:
// - SOC 2: Async operation audit and monitoring
// - ISO 27001: Long-running process controls
//
// =============================================================================

// Options for language-specific code generation and package mappings.
option go_package = "github.com/geniustechspace/api-contracts/gen/go/common/operations/v1";
option java_multiple_files = true;
option java_package = "com.geniustechspace.api.common.operations.v1";
option csharp_namespace = "GeniusTechSpace.Api.Common.Operations.V1";
option php_namespace = "GeniusTechSpace\\Api\\Common\\Operations\\V1";
option ruby_package = "GeniusTechSpace::Api::Common::Operations::V1";

// =============================================================================
// ASYNC OPERATION MESSAGES
// =============================================================================

// AsyncOperation represents a long-running operation that executes asynchronously.
//
// USAGE:
// - Execute operations that exceed request timeout
// - Enable fire-and-forget patterns
// - Support batch processing and data imports
// - Track operation progress and status
//
// EXAMPLE:
//   AsyncOperation op = {
//     operation_id: "async-op-123",
//     status: ASYNC_STATUS_RUNNING,
//     progress: 45.5,
//     started_at: Timestamp(now)
//   };
message AsyncOperation {
  // Unique identifier for this async operation.
  // Used for status polling and result retrieval.
  string operation_id = 1;

  // Original operation request.
  OperationRequest request = 2;

  // Current async operation status.
  AsyncOperationStatus status = 3;

  // Progress percentage (0-100).
  // OPTIONAL: Only for operations that can report progress.
  double progress = 4;

  // Human-readable status message.
  // Example: "Processing 1000 of 2500 records"
  string status_message = 5;

  // Timestamp when operation was queued.
  google.protobuf.Timestamp queued_at = 6;

  // Timestamp when operation started executing.
  // May be significantly after queued_at for queue-based systems.
  google.protobuf.Timestamp started_at = 7;

  // Timestamp when operation completed.
  // Set when status is COMPLETED, FAILED, or CANCELED.
  google.protobuf.Timestamp completed_at = 8;

  // Expected completion time (estimate).
  // OPTIONAL: Provided when operation can estimate duration.
  google.protobuf.Timestamp estimated_completion_at = 9;

  // Total operation duration so far.
  google.protobuf.Duration duration = 10;

  // Operation result (when completed).
  // OPTIONAL: Only set when status is COMPLETED.
  OperationResponse result = 11;

  // Error information (when failed).
  // OPTIONAL: Only set when status is FAILED.
  string error_message = 12;
  int32 error_code = 13;

  // Callback URL for operation completion notification.
  // OPTIONAL: If provided, service posts result to this URL.
  string callback_url = 14;

  // Retry information (if operation was retried).
  RetryInfo retry_info = 15;

  // Cancellation information (if operation was canceled).
  CancellationInfo cancellation_info = 16;

  // Additional operation metadata.
  map<string, string> metadata = 17;

  // Sub-operations (for complex workflows).
  // OPTIONAL: Nested operations within this async operation.
  repeated AsyncOperation sub_operations = 18;

  // Resource locks held by this operation.
  // Used for coordinating concurrent operations.
  repeated ResourceLock locks = 19;
}

// AsyncOperationStatus represents the lifecycle state of an async operation.
enum AsyncOperationStatus {
  ASYNC_STATUS_UNSPECIFIED = 0;

  // Operation is queued but not yet started.
  ASYNC_STATUS_QUEUED = 10;

  // Operation is currently executing.
  ASYNC_STATUS_RUNNING = 20;

  // Operation completed successfully.
  ASYNC_STATUS_COMPLETED = 30;

  // Operation failed with error.
  ASYNC_STATUS_FAILED = 40;

  // Operation was canceled by user/system.
  ASYNC_STATUS_CANCELED = 50;

  // Operation is paused/suspended.
  ASYNC_STATUS_PAUSED = 60;

  // Operation is waiting for dependency.
  ASYNC_STATUS_WAITING = 70;

  // Operation is being retried.
  ASYNC_STATUS_RETRYING = 80;

  // Operation timed out.
  ASYNC_STATUS_TIMEOUT = 90;
}

// RetryInfo provides information about operation retry attempts.
message RetryInfo {
  // Number of retry attempts made.
  int32 attempt_count = 1;

  // Maximum retry attempts allowed.
  int32 max_attempts = 2;

  // Timestamp of first attempt.
  google.protobuf.Timestamp first_attempt_at = 3;

  // Timestamp of last/current attempt.
  google.protobuf.Timestamp last_attempt_at = 4;

  // Timestamp of next retry attempt.
  // OPTIONAL: Set when operation will be retried.
  google.protobuf.Timestamp next_attempt_at = 5;

  // Reason for retry (e.g., "network_timeout", "rate_limit").
  string retry_reason = 6;

  // Backoff strategy used.
  // Example: "exponential", "linear", "constant"
  string backoff_strategy = 7;

  // Current backoff delay.
  google.protobuf.Duration backoff_delay = 8;
}

// CancellationInfo provides information about operation cancellation.
message CancellationInfo {
  // Timestamp when cancellation was requested.
  google.protobuf.Timestamp requested_at = 1;

  // Actor who requested cancellation.
  string requested_by = 2;

  // Reason for cancellation.
  string reason = 3;

  // Timestamp when operation was actually canceled.
  // May differ from requested_at due to graceful shutdown.
  google.protobuf.Timestamp canceled_at = 4;

  // Whether cancellation was forceful.
  // True: Immediate termination. False: Graceful shutdown.
  bool force = 5;
}

// ResourceLock represents a lock held on a resource.
//
// USAGE:
// - Prevent concurrent modifications
// - Coordinate distributed operations
// - Support optimistic/pessimistic locking
message ResourceLock {
  // Lock identifier.
  string lock_id = 1;

  // Resource type being locked.
  string resource_type = 2;

  // Resource identifier being locked.
  string resource_id = 3;

  // Lock type.
  LockType lock_type = 4;

  // Operation holding the lock.
  string operation_id = 5;

  // Timestamp when lock was acquired.
  google.protobuf.Timestamp acquired_at = 6;

  // Lock expiration timestamp.
  // OPTIONAL: For time-limited locks.
  google.protobuf.Timestamp expires_at = 7;

  // Whether lock is still active.
  bool active = 8;
}

// LockType defines the type of resource lock.
enum LockType {
  LOCK_TYPE_UNSPECIFIED = 0;
  LOCK_TYPE_SHARED = 10;      // Multiple readers allowed
  LOCK_TYPE_EXCLUSIVE = 20;   // Single writer, no readers
  LOCK_TYPE_INTENT = 30;      // Intent to acquire lock
}

// =============================================================================
// ASYNC OPERATION CONTROL MESSAGES
// =============================================================================

// GetAsyncOperationRequest requests the status of an async operation.
message GetAsyncOperationRequest {
  // Operation identifier to query.
  string operation_id = 1;

  // Whether to include sub-operations in response.
  // OPTIONAL: Default is false.
  bool include_sub_operations = 2;
}

// ListAsyncOperationsRequest lists async operations with filtering.
message ListAsyncOperationsRequest {
  // Filter by operation status.
  // OPTIONAL: Empty means all statuses.
  repeated AsyncOperationStatus statuses = 1;

  // Filter by operation type.
  // OPTIONAL: Empty means all types.
  repeated Operation operations = 2;

  // Filter by resource type.
  // OPTIONAL: Empty means all resource types.
  string resource_type = 3;

  // Filter by actor.
  // OPTIONAL: Empty means all actors.
  string actor_id = 4;

  // Filter by tenant.
  // OPTIONAL: Empty means all tenants.
  string tenant_id = 5;

  // Start time for filtering.
  // OPTIONAL: Include operations created after this time.
  google.protobuf.Timestamp start_time = 6;

  // End time for filtering.
  // OPTIONAL: Include operations created before this time.
  google.protobuf.Timestamp end_time = 7;

  // Page size for pagination.
  // OPTIONAL: Default is 50, max is 1000.
  int32 page_size = 8;

  // Page token for pagination.
  // OPTIONAL: Token from previous response.
  string page_token = 9;
}

// ListAsyncOperationsResponse returns a page of async operations.
message ListAsyncOperationsResponse {
  // Async operations matching the filter.
  repeated AsyncOperation operations = 1;

  // Token for retrieving the next page.
  // Empty if no more pages.
  string next_page_token = 2;

  // Total count of matching operations.
  // May be approximate for performance reasons.
  int64 total_count = 3;
}

// CancelAsyncOperationRequest requests cancellation of an async operation.
message CancelAsyncOperationRequest {
  // Operation identifier to cancel.
  string operation_id = 1;

  // Reason for cancellation.
  // OPTIONAL: Logged for audit purposes.
  string reason = 2;

  // Whether to force immediate cancellation.
  // True: Immediate termination. False: Graceful shutdown.
  // OPTIONAL: Default is false.
  bool force = 3;

  // Actor requesting cancellation.
  // REQUIRED: For authorization and audit.
  string requested_by = 4;
}

// CancelAsyncOperationResponse confirms operation cancellation.
message CancelAsyncOperationResponse {
  // Operation identifier.
  string operation_id = 1;

  // Whether cancellation was accepted.
  bool accepted = 2;

  // Current operation status after cancellation request.
  AsyncOperationStatus status = 3;

  // Message describing cancellation status.
  string message = 4;
}

// RetryAsyncOperationRequest requests retry of a failed async operation.
message RetryAsyncOperationRequest {
  // Operation identifier to retry.
  string operation_id = 1;

  // Reason for retry.
  // OPTIONAL: Logged for audit purposes.
  string reason = 2;

  // Actor requesting retry.
  // REQUIRED: For authorization and audit.
  string requested_by = 3;

  // Whether to reset retry count.
  // OPTIONAL: Default is false (continue from current attempt).
  bool reset_retry_count = 4;
}

// RetryAsyncOperationResponse confirms operation retry.
message RetryAsyncOperationResponse {
  // Operation identifier.
  string operation_id = 1;

  // Whether retry was accepted.
  bool accepted = 2;

  // New operation status after retry request.
  AsyncOperationStatus status = 3;

  // Message describing retry status.
  string message = 4;

  // Estimated time until retry attempt.
  google.protobuf.Duration retry_delay = 5;
}
