syntax = "proto3";

package geniustechspace.common.operations.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/any.proto";
import "common/operations/types.proto";

// =============================================================================
// OPERATION RESPONSE MESSAGES - v1.0.0
// =============================================================================
//
// This file defines standardized response envelopes for operation execution
// results across the organizations platform.
//
// DESIGN PRINCIPLES:
// - Provide consistent response structure for all operations
// - Include comprehensive execution metadata
// - Support both success and error scenarios
// - Enable performance monitoring and debugging
//
// VERSION HISTORY:
// - 1.0.0 (2025-11-01): Initial enterprise-standard release
//
// COMPLIANCE SCOPE:
// - SOC 2: Operation outcome tracking and audit
// - ISO 27001: Security event logging
// - GDPR: Data processing records
//
// =============================================================================

// Options for language-specific code generation and package mappings.
option go_package = "github.com/geniustechspace/api-contracts/gen/go/common/operations/v1";
option java_multiple_files = true;
option java_package = "com.geniustechspace.api.common.operations.v1";
option csharp_namespace = "GeniusTechSpace.Api.Common.Operations.V1";
option php_namespace = "GeniusTechSpace\\Api\\Common\\Operations\\V1";
option ruby_package = "GeniusTechSpace::Api::Common::Operations::V1";

// =============================================================================
// OPERATION RESPONSE
// =============================================================================

// OperationResponse represents a standardized response envelope for operation
// execution results.
//
// USAGE:
// - Wrap service-specific responses with operation metadata
// - Include execution details for monitoring and debugging
// - Support both success and error scenarios
// - Provide timing information for performance analysis
//
// SECURITY:
// - Error messages should not expose sensitive information
// - Sanitize PII/PHI from error details
// - Log full error context server-side for debugging
//
// COMPLIANCE:
// - All fields logged for audit and compliance
// - Execution timing tracked for SLA monitoring
// - Error codes mapped to compliance requirements
//
// EXAMPLE:
//   OperationResponse response = {
//     operation_id: "op-789-xyz",
//     operation: OPERATION_CREATE,
//     status: STATUS_SUCCESS,
//     resource_id: "user-123",
//     response_data: Any(CreateUserResponse {...})
//   };
message OperationResponse {
  // Unique identifier for this operation execution.
  // Generated by the service for tracking and audit purposes.
  // Used for operation lookup, debugging, and support.
  string operation_id = 1;

  // Type of operation that was executed.
  // Echoes the requested operation from OperationRequest.
  Operation operation = 2;

  // Type of resource the operation targeted.
  // Echoes the resource type from OperationRequest.
  string resource_type = 3;

  // Unique identifier of the resource (if applicable).
  // Set for operations that created or modified a resource.
  string resource_id = 4;

  // High-level status of the operation.
  // Uses Status enum from common.enums.
  // Values: SUCCESS, FAILURE, PENDING, PARTIAL_SUCCESS, etc.
  int32 status = 5;

  // Error code if the operation failed.
  // Uses ErrorCode enum from common.enums.
  // OPTIONAL: Only set if status indicates failure.
  int32 error_code = 6;

  // Human-readable error message (if applicable).
  // OPTIONAL: Should be localized in UI layer, not in proto.
  // Must not expose sensitive information or implementation details.
  string error_message = 7;

  // Service-specific response payload.
  // Type should match the operation and resource type.
  // Contains the actual business logic response data.
  google.protobuf.Any response_data = 8;

  // Timestamp when the operation started.
  // Used for audit logging and performance analysis.
  google.protobuf.Timestamp started_at = 9;

  // Timestamp when the operation completed.
  // Used for audit logging and SLA tracking.
  google.protobuf.Timestamp completed_at = 10;

  // Duration of the operation execution.
  // Calculated as completed_at - started_at.
  // Used for performance monitoring and optimization.
  google.protobuf.Duration duration = 11;

  // Additional metadata about the operation execution.
  // Common keys: "retry_count", "backend_service", "cache_hit"
  map<string, string> metadata = 12;

  // Echo of the client's correlation ID for tracing.
  // Propagated from OperationRequest for distributed tracing.
  string correlation_id = 13;

  // Detailed error information (if applicable).
  // OPTIONAL: Only set for failures requiring detailed debugging.
  ErrorDetail error_detail = 14;

  // Warning messages that don't prevent operation success.
  // OPTIONAL: Used for partial success or degraded operations.
  repeated Warning warnings = 15;

  // Validation errors for malformed requests.
  // OPTIONAL: Only set when validation fails before execution.
  repeated ValidationError validation_errors = 16;

  // Resource version/etag for optimistic concurrency control.
  // OPTIONAL: Used for UPDATE operations to prevent conflicts.
  string resource_version = 17;

  // Indicates if operation was served from cache.
  // OPTIONAL: Used for performance analysis and debugging.
  bool from_cache = 18;

  // Retry information (if operation was retried).
  // OPTIONAL: Only set if operation was retried due to transient failures.
  RetryInfo retry_info = 19;
}

// ErrorDetail provides comprehensive error information for debugging and support.
//
// USAGE:
// - Include detailed error context for server-side logging
// - Provide actionable error information for clients
// - Support error categorization and analysis
//
// SECURITY:
// - Must not expose sensitive data or implementation details
// - Sanitize stack traces and internal error messages
message ErrorDetail {
  // Error domain/category.
  // Example: "authentication", "validation", "storage", "network"
  string domain = 1;

  // Specific error reason within the domain.
  // Example: "invalid_credentials", "expired_token", "quota_exceeded"
  string reason = 2;

  // Additional error metadata.
  // Example: {"field": "email", "constraint": "unique"}
  map<string, string> metadata = 3;

  // User-facing help URL for error resolution.
  // Should point to documentation or troubleshooting guide.
  string help_url = 4;

  // Stack trace (sanitized for production).
  // OPTIONAL: Only include in development/staging environments.
  repeated string stack_trace = 5;

  // Request ID for support and debugging.
  // Same as operation_id from parent OperationResponse.
  string request_id = 6;

  // Timestamp when error occurred.
  google.protobuf.Timestamp occurred_at = 7;
}

// Warning represents a non-fatal issue during operation execution.
//
// USAGE:
// - Report issues that don't prevent operation success
// - Alert clients to potential problems
// - Track degraded operation scenarios
message Warning {
  // Warning code for categorization.
  // Example: "DEPRECATED_API", "PARTIAL_RESULT", "PERFORMANCE_DEGRADED"
  string code = 1;

  // Human-readable warning message.
  string message = 2;

  // Affected field or resource.
  // OPTIONAL: Indicates which part of the operation triggered warning.
  string field = 3;

  // Additional warning metadata.
  map<string, string> metadata = 4;
}

// ValidationError represents a field-level validation failure.
//
// USAGE:
// - Report specific validation failures before operation execution
// - Enable client-side error handling and UI feedback
// - Support form validation and user guidance
message ValidationError {
  // Field path that failed validation.
  // Example: "user.email", "address.postal_code"
  string field = 1;

  // Validation error code.
  // Example: "REQUIRED", "INVALID_FORMAT", "OUT_OF_RANGE"
  string code = 2;

  // Human-readable error message.
  // Should be clear and actionable for end users.
  string message = 3;

  // Expected value or constraint.
  // Example: "email format", "length <= 100"
  string constraint = 4;

  // Actual value that failed validation (sanitized).
  // OPTIONAL: May be omitted for security reasons.
  string actual_value = 5;
}

// RetryInfo provides information about operation retry attempts.
//
// USAGE:
// - Track retry behavior for transient failures
// - Support exponential backoff strategies
// - Enable retry analysis and optimization
message RetryInfo {
  // Number of retry attempts made.
  int32 attempt_count = 1;

  // Timestamp of first attempt.
  google.protobuf.Timestamp first_attempt_at = 2;

  // Timestamp of last/final attempt.
  google.protobuf.Timestamp last_attempt_at = 3;

  // Reason for retry (e.g., "network_timeout", "rate_limit").
  string retry_reason = 4;

  // Whether retry was successful.
  bool retry_successful = 5;

  // Total time spent in retries.
  google.protobuf.Duration total_retry_duration = 6;
}
