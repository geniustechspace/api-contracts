syntax = "proto3";

package geniustechspace.common.operations.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";
import "common/operations/types.proto";

// =============================================================================
// OPERATION TRACKING & INDEXING - v1.0.0
// =============================================================================
//
// This file defines messages for operation tracking, indexing, and audit trail
// across the organizations platform.
//
// DESIGN PRINCIPLES:
// - Enable efficient operation lookup and search
// - Support comprehensive audit requirements
// - Track operation lineage and dependencies
// - Facilitate compliance reporting
//
// VERSION HISTORY:
// - 1.0.0 (2025-11-01): Initial enterprise-standard release
//
// COMPLIANCE SCOPE:
// - SOC 2: Operation audit trail and access logs
// - ISO 27001: Security event tracking (A.12.4)
// - GDPR: Data processing activity records (Article 30)
// - HIPAA: PHI access audit logs (ยง164.312(b))
//
// =============================================================================

// Options for language-specific code generation and package mappings.
option go_package = "github.com/geniustechspace/api-contracts/gen/go/common/operations/v1";
option java_multiple_files = true;
option java_package = "com.geniustechspace.api.common.operations.v1";
option csharp_namespace = "GeniusTechSpace.Api.Common.Operations.V1";
option php_namespace = "GeniusTechSpace\\Api\\Common\\Operations\\V1";
option ruby_package = "GeniusTechSpace::Api::Common::Operations::V1";

// =============================================================================
// OPERATION INDEX
// =============================================================================

// OperationIndex provides a searchable index entry for operation tracking.
//
// USAGE:
// - Enable operation lookup and search
// - Support audit queries and compliance reporting
// - Track operation lineage and dependencies
// - Facilitate incident investigation and debugging
//
// SECURITY:
// - IP address and user agent tracked for security analysis
// - Sensitive data must be sanitized before indexing
// - Access to index records controlled by authorization
//
// COMPLIANCE:
// - Required for SOC 2 audit trail
// - Essential for GDPR data processing records
// - Supports HIPAA PHI access tracking
// - Enables compliance reporting and analytics
//
// EXAMPLE:
//   OperationIndex index = {
//     operation_id: "op-789-xyz",
//     operation: OPERATION_CREATE,
//     resource_type: "user",
//     resource_id: "user-123",
//     actor_id: "admin-456",
//     timestamp: Timestamp(now)
//   };
message OperationIndex {
  // Unique identifier for the operation.
  // Primary key for operation lookup and tracking.
  string operation_id = 1;

  // Type of operation performed.
  // Used for filtering and categorizing operations.
  Operation operation = 2;

  // Resource type targeted by the operation.
  // Example: "user", "organization", "payment"
  string resource_type = 3;

  // Resource identifier (if applicable).
  // Used for resource-specific audit queries.
  string resource_id = 4;

  // Actor who performed the operation.
  // User ID, service account ID, or API key identifier.
  string actor_id = 5;

  // Timestamp when operation occurred.
  // Used for time-based queries and retention policies.
  google.protobuf.Timestamp timestamp = 6;

  // Operation status.
  // Uses Status enum from common.enums.
  int32 status = 7;

  // Error code (if failed).
  // Uses ErrorCode enum from common.enums.
  int32 error_code = 8;

  // Operation execution duration.
  // Used for performance analysis and SLA tracking.
  google.protobuf.Duration duration = 9;

  // Source IP address of the request.
  // Critical for security monitoring and incident investigation.
  string ip_address = 10;

  // User agent / client identifier.
  // Example: Browser user agent, client SDK version.
  string user_agent = 11;

  // Idempotency key (if provided).
  // Used to track duplicate operation attempts.
  string idempotency_key = 12;

  // Correlation ID for distributed tracing.
  // Links related operations across services.
  string correlation_id = 13;

  // Parent operation ID (for nested/dependent operations).
  // Enables operation hierarchy and workflow tracking.
  string parent_operation_id = 14;

  // Tenant/organization ID (for multi-tenant systems).
  // Essential for tenant isolation and billing.
  string tenant_id = 15;

  // Additional searchable tags.
  // Used for custom categorization and filtering.
  // Example: {"environment": "production", "region": "us-east-1"}
  map<string, string> tags = 16;

  // Service/component that executed the operation.
  // Example: "user-service", "payment-gateway"
  string service_name = 17;

  // Service version that executed the operation.
  // Used for rollback correlation and debugging.
  string service_version = 18;

  // Geographic region where operation was executed.
  // Example: "us-east-1", "eu-west-1"
  string region = 19;

  // Indicates if operation accessed sensitive data (PII/PHI).
  // Critical for compliance reporting and data protection.
  bool sensitive_data_accessed = 20;

  // Data classification level.
  // Example: "public", "internal", "confidential", "restricted"
  string data_classification = 21;

  // Size of request payload in bytes.
  // Used for capacity planning and anomaly detection.
  int64 request_size_bytes = 22;

  // Size of response payload in bytes.
  int64 response_size_bytes = 23;

  // Number of database queries executed.
  // Used for performance optimization.
  int32 db_query_count = 24;

  // Number of external API calls made.
  // Used for dependency tracking and debugging.
  int32 external_api_calls = 25;
}

// OperationTrace provides detailed trace information for distributed operations.
//
// USAGE:
// - Track operation flow across multiple services
// - Support distributed debugging and performance analysis
// - Enable end-to-end latency tracking
// - Facilitate capacity planning
message OperationTrace {
  // Unique trace identifier.
  // Shared across all spans in the trace.
  string trace_id = 1;

  // Unique span identifier.
  // Identifies this specific operation in the trace.
  string span_id = 2;

  // Parent span identifier (if nested operation).
  // Links spans in hierarchical relationship.
  string parent_span_id = 3;

  // Operation being traced.
  Operation operation = 4;

  // Service/component executing this span.
  string service_name = 5;

  // Span start timestamp.
  google.protobuf.Timestamp start_time = 6;

  // Span end timestamp.
  google.protobuf.Timestamp end_time = 7;

  // Span duration.
  google.protobuf.Duration duration = 8;

  // Span status (success/failure).
  int32 status = 9;

  // Span attributes/tags.
  // Additional context about the span.
  map<string, string> attributes = 10;

  // Events that occurred during span execution.
  repeated TraceEvent events = 11;

  // Links to related spans.
  repeated SpanLink links = 12;
}

// TraceEvent represents a significant event during operation execution.
message TraceEvent {
  // Event name.
  // Example: "db_query_start", "cache_miss", "retry_attempt"
  string name = 1;

  // Timestamp when event occurred.
  google.protobuf.Timestamp timestamp = 2;

  // Event attributes.
  map<string, string> attributes = 3;
}

// SpanLink connects related spans across different traces.
message SpanLink {
  // Linked trace ID.
  string trace_id = 1;

  // Linked span ID.
  string span_id = 2;

  // Link type/relationship.
  // Example: "follows_from", "child_of", "caused_by"
  string link_type = 3;

  // Link attributes.
  map<string, string> attributes = 4;
}

// OperationAuditLog provides comprehensive audit log entry for compliance.
//
// USAGE:
// - Record all operations for compliance auditing
// - Support forensic investigation
// - Enable compliance reporting
// - Track data subject access and modifications
//
// COMPLIANCE:
// - Required for SOC 2 Type II audit trail
// - Essential for GDPR Article 30 records
// - Mandatory for HIPAA PHI access logs
// - Supports PCI DSS audit requirements
message OperationAuditLog {
  // Unique audit log entry identifier.
  string audit_id = 1;

  // Operation being audited.
  // References OperationIndex for detailed operation info.
  string operation_id = 2;

  // Operation type.
  Operation operation = 3;

  // Timestamp when audit entry was created.
  google.protobuf.Timestamp audit_timestamp = 4;

  // Actor who performed the operation.
  ActorInfo actor = 5;

  // Resource affected by the operation.
  ResourceInfo resource = 6;

  // Operation outcome.
  int32 status = 7;

  // Changes made by the operation (before/after).
  // OPTIONAL: Only for UPDATE operations.
  repeated FieldChange changes = 8;

  // Access justification (for sensitive data access).
  // REQUIRED: For operations accessing PII/PHI.
  string access_justification = 9;

  // Approval/authorization reference.
  // OPTIONAL: For operations requiring elevated privileges.
  string authorization_reference = 10;

  // Risk level assessed for this operation.
  // Based on actor, resource, and context.
  int32 risk_level = 11;

  // Compliance flags.
  // Indicates which compliance requirements this log satisfies.
  repeated string compliance_tags = 12;

  // Retention policy for this audit log.
  // Example: "7_years_financial", "indefinite_legal_hold"
  string retention_policy = 13;
}

// ActorInfo provides detailed information about the actor performing an operation.
message ActorInfo {
  // Actor identifier.
  string actor_id = 1;

  // Actor type.
  // Example: "user", "service_account", "api_key", "admin"
  string actor_type = 2;

  // Actor email (if applicable).
  string actor_email = 3;

  // Actor display name.
  string actor_name = 4;

  // Actor roles/permissions at time of operation.
  repeated string roles = 5;

  // Authentication method used.
  // Example: "password", "sso", "mfa", "certificate"
  string auth_method = 6;

  // Session identifier.
  string session_id = 7;

  // IP address.
  string ip_address = 8;

  // Geographic location (if available).
  string geo_location = 9;
}

// ResourceInfo provides detailed information about the resource affected.
message ResourceInfo {
  // Resource type.
  string resource_type = 1;

  // Resource identifier.
  string resource_id = 2;

  // Resource display name (if applicable).
  string resource_name = 3;

  // Resource owner.
  string resource_owner = 4;

  // Data classification level.
  string data_classification = 5;

  // Indicates if resource contains PII.
  bool contains_pii = 6;

  // Indicates if resource contains PHI.
  bool contains_phi = 7;

  // Resource tags/labels.
  map<string, string> tags = 8;
}

// FieldChange represents a modification to a specific field.
message FieldChange {
  // Field path that was modified.
  // Example: "user.email", "organization.settings.billing_enabled"
  string field_path = 1;

  // Value before the change (sanitized).
  string old_value = 2;

  // Value after the change (sanitized).
  string new_value = 3;

  // Field data classification.
  string data_classification = 4;

  // Indicates if field contains PII/PHI.
  bool sensitive = 5;
}
